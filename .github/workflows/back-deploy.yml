name: Deploy firebase functions
on:
    push:
      branches:
      - production
jobs:
    main:
        env:
            GOOGLE_APPLICATION_CREDENTIALS: google-application-credentials.json
        name: Deploy
        runs-on: ubuntu-latest
        steps:
        - name: Check out code
          uses: actions/checkout@master

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '18'

        - name: Cache Dependencies
          uses: actions/cache@v3
          id: cache-dependencies
          with:
              path: |
                ~/.npm
                ~/.cache/firebase
              key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
              restore-keys: |
                ${{ runner.os }}-node-

        - name: Prepare Google Application Credentials
          shell: bash
          run: |
            echo "${{ secrets.GOOGLE_APPLICATION_CREDENTIALS }}" | base64 --decode > "google-application-credentials.json"

        - name: Install Dependencies
          run: cd back/functions && npm install
    
        - name: Generate TSOA Specs and Routes
          run: cd back/functions && npm run deploy